@let hasDestination = !!targetUrlModel();

<form #formRef autocomplete="off" (submit)="next()">
  <div style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden">
    <input type="text" name="fake_email" tabindex="-1" />
    <input type="password" name="fake_password" tabindex="-1" />
  </div>

  <header>
    <h3 class="title-30">
      <span i18n>Backup destination</span>

      <div class="actions">
        @if (!hasDestination) {
          <button shButton type="button" class="small" (click)="openTargetUrlDialog()" i18n>
            <sh-icon>link</sh-icon>
            Set target URL
          </button>
        } @else {
          <sh-menu>
            <button shButton type="button" class="small">
              <sh-icon>dots-three-vertical</sh-icon>
            </button>

            <ng-container menu>
              <button shButton type="button" class="small" (click)="openTargetUrlDialog()" i18n>
                <sh-icon>link</sh-icon>
                Edit target URL
              </button>
              @if (hasDestination) {
                <button shButton type="button" class="small" (click)="copyTargetUrl()" i18n>
                  <sh-icon>copy</sh-icon>
                  Copy URL to clipboard
                </button>
              }
            </ng-container>
          </sh-menu>
        }
      </div>
    </h3>

    <app-test-url
      #testUrl
      [(targetUrl)]="targetUrlModel"
      [(testSignal)]="testSignal"
      [suppressErrorDialogs]="false"
      [askToCreate]="true"
      [testExpectation]="isNew() ? 'destinationEmpty' : 'any'"
      [moduleType]="'Backend'"></app-test-url>

    <app-destination-list-item [targetUrl]="targetUrlModel()" class="current-destination">
      <button shButton i18n (click)="removeDestination()" type="button">Change</button>
    </app-destination-list-item>
  </header>

  @if (!hasDestination) {
    @if (!showCustomList()) {
      @if (isLoadingDestinations()) {
        <div class="loading-list">
          <sh-progress-bar class="indeterminate primary"></sh-progress-bar>
          <div class="text">
            <h3 i18n>Loading destinations...</h3>
          </div>
        </div>
      } @else {
        <sh-card class="type-a actionable add-new" (click)="toggleCustomList()">
          <sh-icon>plus-circle</sh-icon>
          <div class="text">
            <h3 i18n>Configure a new destination</h3>
            <p i18n>Configure a one-off or new storage location.</p>
          </div>
        </sh-card>

        @if (destinations().length > 0) {
          <sh-divider i18n>Or select a saved destination</sh-divider>
        }

        @for (option of destinations(); track $index) {
          <app-destination-list-item
            class="actionable"
            variant="type-a"
            [targetUrl]="option.BaseUrl"
            (click)="selectSavedDestination(option)">
            <h3 displayName>{{ option.Name || option.BaseUrl }}</h3>
            @if (option.Description) {
              <p description>{{ option.Description }}</p>
            } @else {
              <p description>{{ getSimplePath(option.BaseUrl) }}</p>
            }
          </app-destination-list-item>
        }
      }
    } @else {
      <div class="custom-list-header">
        <button shButton iconOnly variant="ghost" (click)="showCustomList.set(false)" type="button">
          <sh-icon>arrow-left</sh-icon>
        </button>
        <h3 i18n>Select storage type</h3>
      </div>
      <app-destination-list (setDestination)="setDestination($event)"></app-destination-list>
    }
  }

  @if (hasDestination) {
    <app-single-destination [(targetUrl)]="targetUrlModel" [useBackupState]="true" />
  }

  <div class="form-actions">
    <button shButton type="button" (click)="goBack()" i18n>
      <sh-icon>arrow-left</sh-icon>
      Go back
    </button>

    <button
      shButton
      class="raised primary"
      [class.loading]="testSignal() == 'testing'"
      type="submit"
      [disabled]="testSignal() == 'testing' || !hasDestination"
      i18n>
      <sh-icon>arrow-right</sh-icon>
      Continue
    </button>
  </div>
</form>

@if (targetUrlDialogOpen()) {
  <sh-dialog [(isOpen)]="targetUrlDialogOpen" [options]="{ maxWidth: '700px', width: '100%' }">
    <header header>
      <div class="target-dialog-header">
        @if (!hasDestination) {
          <h2 i18n>Set target URL</h2>
        } @else {
          <h2 i18n>Edit target URL</h2>
        }
        <sh-alert class="warn" i18n>Be careful, this will overwrite everything you have in your destination.</sh-alert>
      </div>
    </header>

    <div content>
      <sh-form-field>
        <textarea id="targetUrl" autocomplete="off" [(ngModel)]="targetUrlCtrl"></textarea>
      </sh-form-field>
    </div>

    <footer footer>
      <button shButton type="button" (click)="closeTargetUrlDialog(false)">Cancel</button>

      <button shButton class="raised primary" type="submit" (click)="closeTargetUrlDialog(true)" i18n>
        Override target URL
        <sh-icon>swap</sh-icon>
      </button>
    </footer>
  </sh-dialog>
}
