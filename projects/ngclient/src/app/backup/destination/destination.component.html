@let currentTargets = targetUrls();
@let hasDestination = currentTargets.length > 0;

<form #formRef autocomplete="off" (submit)="next()">
  <div style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden">
    <input type="text" name="fake_email" tabindex="-1" />
    <input type="password" name="fake_password" tabindex="-1" />
  </div>

  <header>
    @if (currentEditingIndex() !== null || (!showCustomList() && !isAddingNew())) {
      @for (dest of currentTargets; track $index) {
        @if (showCustomList() && currentEditingIndex() === $index) {
          <sh-card class="destination-card type-c editing">
            <div class="editing-header">
              <h3 i18n>Change destination type</h3>
              <button shButton class="small" (click)="closeCustomList()" type="button">
                Cancel
                <sh-icon>x-bold</sh-icon>
              </button>
            </div>
            <app-destination-list (setDestination)="setDestination($event)"></app-destination-list>
          </sh-card>
        } @else {
          <sh-toggle-card class="destination-card type-a" [disableToggle]="true" [isActive]="true">
            <ng-container title>
              <app-destination-list-item [targetUrl]="dest.url" [connectionStringId]="dest.connectionStringId">
                <button shButton class="small" (click)="changeDestination($index)" type="button">Change</button>

                <sh-menu class="actions" (click)="$event.stopPropagation()">
                  <button shButton type="button" class="small icon-only">
                    <sh-icon>dots-three-vertical</sh-icon>
                  </button>

                  <ng-container menu>
                    <button shButton type="button" class="small" (click)="openTargetUrlDialog($index)" i18n>
                      <sh-icon>link</sh-icon>
                      Edit target URL
                    </button>
                    <button shButton type="button" class="small" (click)="copyTargetUrl($index)" i18n>
                      <sh-icon>copy</sh-icon>
                      Copy URL to clipboard
                    </button>
                    <button shButton type="button" class="small" (click)="removeDestination($index)" i18n>
                      <sh-icon>trash</sh-icon>
                      Remove
                    </button>
                  </ng-container>
                </sh-menu>
              </app-destination-list-item>
            </ng-container>

            <app-test-url
              #testUrl
              [targetUrl]="dest.url"
              (targetUrlChange)="updateTargetUrl($index, $event)"
              [testSignal]="testStates()[$index] || null"
              (testSignalChange)="updateTestState($index, $event)"
              [connectionStringId]="dest.connectionStringId"
              [suppressErrorDialogs]="false"
              [askToCreate]="true"
              [testExpectation]="isNew() ? 'destinationEmpty' : 'any'"
              [moduleType]="'Backend'" />

            <app-single-destination
              [targetUrl]="dest.url"
              (targetUrlChange)="updateTargetUrl($index, $event)"
              [useBackupState]="true" />
          </sh-toggle-card>
        }
      }
    }
  </header>

  @if ((!hasDestination || showCustomList() || isAddingNew()) && currentEditingIndex() === null) {
    @if (!showCustomList() && !hasDestination && !isAddingNew()) {
      @if (isLoadingDestinations()) {
        <div class="loading-list">
          <sh-progress-bar class="indeterminate primary"></sh-progress-bar>
          <div class="text">
            <h3 i18n>Loading destinations...</h3>
          </div>
        </div>
      } @else {
        <sh-card class="type-a actionable add-new" (click)="toggleCustomList()">
          <sh-icon>plus-circle</sh-icon>
          <div class="text">
            <h3 i18n>Configure a new destination</h3>
            <p i18n>Configure a one-off or new storage location.</p>
          </div>
        </sh-card>

        @if (destinations().length > 0) {
          <sh-divider i18n>Or select a saved destination</sh-divider>
        }

        @for (option of destinations(); track $index) {
          <app-destination-list-item
            class="actionable"
            variant="type-a"
            [targetUrl]="option.BaseUrl"
            (click)="selectSavedDestination(option)">
            <h3 displayName>{{ option.Name || option.BaseUrl }}</h3>
            @if (option.Description) {
              <p description>{{ option.Description }}</p>
            } @else {
              <p description>{{ getSimplePath(option.BaseUrl) }}</p>
            }
          </app-destination-list-item>
        }
      }
    } @else if (isAddingNew() && !showCustomList()) {
      <div class="custom-list-header">
        <button shButton iconOnly variant="ghost" (click)="closeCustomList()" type="button">
          <sh-icon>arrow-left</sh-icon>
          Back
        </button>
      </div>

      <sh-card class="type-a actionable add-new" (click)="toggleCustomList()">
        <sh-icon>plus-circle</sh-icon>
        <div class="text">
          <h3 i18n>Configure a new destination</h3>
          <p i18n>Configure a one-off or new storage location.</p>
        </div>
      </sh-card>

      @if (destinations().length > 0) {
        <sh-divider i18n>Or select a saved destination</sh-divider>
      }

      @for (option of destinations(); track $index) {
        <app-destination-list-item
          class="actionable"
          variant="type-a"
          [targetUrl]="option.BaseUrl"
          (click)="selectSavedDestination(option)">
          <h3 displayName>{{ option.Name || option.BaseUrl }}</h3>
          @if (option.Description) {
            <p description>{{ option.Description }}</p>
          } @else {
            <p description>{{ getSimplePath(option.BaseUrl) }}</p>
          }
        </app-destination-list-item>
      }
    } @else {
      <div class="custom-list-header">
        <button shButton iconOnly variant="ghost" (click)="closeCustomList()" type="button">
          <sh-icon>arrow-left</sh-icon>
        </button>
        <h3 i18n>Select storage type</h3>
      </div>
      <app-destination-list (setDestination)="setDestination($event)"></app-destination-list>
    }
  }

  @if (hasDestination && !showCustomList() && !isAddingNew()) {
    <div class="add-destination-container">
      <button shButton class="secondary" (click)="startAddingNew()" type="button">
        <sh-icon>plus</sh-icon>
        Add another destination
      </button>
    </div>
  }

  <div class="form-actions">
    <button shButton type="button" (click)="goBack()" i18n>
      <sh-icon>arrow-left</sh-icon>
      Go back
    </button>

    <button
      shButton
      class="raised primary"
      [class.loading]="isNew() && testStates().length > 0 && testStates()[0] === 'testing'"
      type="submit"
      [disabled]="!hasDestination"
      i18n>
      <sh-icon>arrow-right</sh-icon>
      Continue
    </button>
  </div>
</form>

@if (targetUrlDialogOpen()) {
  <sh-dialog [(isOpen)]="targetUrlDialogOpen" [options]="{ maxWidth: '700px', width: '100%' }">
    <header header>
      <div class="target-dialog-header">
        @if (!hasDestination) {
          <h2 i18n>Set target URL</h2>
        } @else {
          <h2 i18n>Edit target URL</h2>
        }
        <sh-alert class="warn" i18n>Be careful, this will overwrite everything you have in your destination.</sh-alert>
      </div>
    </header>

    <div content>
      <sh-form-field>
        <textarea id="targetUrl" autocomplete="off" [(ngModel)]="targetUrlCtrl"></textarea>
      </sh-form-field>
    </div>

    <footer footer>
      <button shButton type="button" (click)="closeTargetUrlDialog(false)">Cancel</button>

      <button shButton class="raised primary" type="submit" (click)="closeTargetUrlDialog(true)" i18n>
        Override target URL
        <sh-icon>swap</sh-icon>
      </button>
    </footer>
  </sh-dialog>
}
