@let _destinationType = destinationType();
@let config = destinationFormConfig();

@if (_destinationType && config) {
  @let form = destinationForm();

  <!-- <pre>{{ targetUrl() }}</pre> -->

  @for (formView of config.custom; track $index) {
    <ng-container
      *ngTemplateOutlet="
        fieldTemplate;
        context: {
          $implicit: {
            index: $index,
            fieldGroup: 'custom',
            formView,
            destinationType: _destinationType,
            oauthField: config.oauthField,
          },
        }
      "></ng-container>
  }

  @for (formView of config.dynamic; track $index) {
    <ng-container
      *ngTemplateOutlet="
        fieldTemplate;
        context: {
          $implicit: {
            index: $index,
            fieldGroup: 'dynamic',
            formView: formView,
            destinationType: _destinationType,
            oauthField: config.oauthField,
          },
        }
      "></ng-container>
  }

  <sh-toggle-card [disallowToggle]="true" class="advanced-options">
    <ng-container title>
      <ng-container i18n>Advanced options</ng-container>

      @let _nonSelectedAdvancedFormViews = nonSelectedAdvancedFormViews();

      @if (showTextArea()) {
        <button shButton type="button" class="outlined small" (click)="showTextArea.set(false)" i18n>
          Show editor
          <sh-icon>link</sh-icon>
        </button>
      } @else {
        <div class="actions">
          <sh-menu [searchable]="true">
            <button
              i18n
              shButton
              type="button"
              class="outlined small"
              [disabled]="_nonSelectedAdvancedFormViews.length === 0">
              Add advanced option
              <sh-icon>plus</sh-icon>
            </button>

            <ng-container menu>
              @for (formView of _nonSelectedAdvancedFormViews; track $index) {
                <button #option type="button" (click)="addAdvancedOption(formView)">
                  {{ formView.name }}
                </button>
              }
            </ng-container>
          </sh-menu>

          <sh-menu>
            <button shButton type="button" class="small">
              <sh-icon>dots-three-vertical</sh-icon>
            </button>

            <ng-container menu>
              <button shButton type="button" class="small" (click)="showTextArea.set(true)">
                <sh-icon>link</sh-icon>
                Edit contents as text
              </button>
            </ng-container>
          </sh-menu>
        </div>
      }
    </ng-container>

    @if (showTextArea()) {
      <textarea
        class="raw-text-area"
        wrap="off"
        [ngModel]="settingsAsText()"
        (ngModelChange)="updateSettingsFromText($event)"
        [ngModelOptions]="{ updateOn: 'blur' }"
        placeholder="Paste advanced options here, one per line."></textarea>
    } @else {
      @for (optionName of advancedFormFieldNames(); track $index) {
        @let formView = getFormView('advanced', optionName) ?? getDefaultFormView(optionName);

        <ng-container
          *ngTemplateOutlet="
            fieldTemplate;
            context: {
              $implicit: {
                index: $index,
                formView: formView,
                fieldGroup: 'advanced',
                destinationType: _destinationType,
                oauthField: config.oauthField,
              },
            }
          "></ng-container>
      }
    }
  </sh-toggle-card>

  <ng-template #fieldTemplate let-item>
    <div class="field-row" [class.single-field]="item.fieldGroup !== 'advanced'">
      @let labelContent = item.formView.shortDescription ?? item.formView.name;
      @let formInput = getFieldGroup(form, item.fieldGroup)[item.formView.name];
      @let fieldValue = getFieldValue(item.fieldGroup, item.formView.name);
      @let isFieldEmpty = (fieldValue ?? '').toString().trim() === '';
      @let formFieldId =
        'destination-' + item.fieldGroup + '-' + item.index + '-' + (item.asHttpOptions ? 'http' : 'other');

      @if (item.formView.type === 'FileTree') {
        <app-file-tree
          [startingPath]="fieldValue"
          [accepts]="item.formView.accepts"
          [showFiles]="true"
          [hideShortcuts]="true"
          [showHiddenNodes]="true"
          [selectFiles]="true">
          <label [for]="formFieldId">
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
          <input
            type="text"
            [id]="formFieldId"
            [ngModel]="formInput"
            (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />
        </app-file-tree>
      } @else if (item.formView.type === 'FolderTree') {
        <app-file-tree [hideShortcuts]="true" [enableCreateFolder]="true" [startingPath]="fieldValue">
          <label [for]="formFieldId">
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
          <input
            type="text"
            [id]="formFieldId"
            [ngModel]="formInput"
            (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />
        </app-file-tree>
      } @else if (
        item.formView.type === 'String' ||
        item.formView.type === 'Path' ||
        item.formView.type === 'Email' ||
        item.formView.type === 'Hostname' ||
        item.formView.type === 'Bucketname' ||
        item.formView.type === 'BucketnameB2'
      ) {
        <sh-form-field>
          <label [for]="formFieldId">
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
            @if (isFieldEmpty && item.formView.type === 'Path') {
              <sh-icon
                class="warn"
                i18n-shTooltip
                shTooltip="An empty path means storing data in the initial or root folder, which is not recommended">
                warning
              </sh-icon>
            }
            @if (item.formView.type == 'Hostname' && !isFieldEmpty && !isValidHostname(fieldValue)) {
              <sh-icon class="error" i18n-shTooltip shTooltip="Hostname is invalid">x-circle</sh-icon>
            }
            @if (item.formView.type == 'Bucketname' && !isFieldEmpty && !isValidBucketname(fieldValue)) {
              <sh-icon class="warn" i18n-shTooltip shTooltip="Bucket name is invalid">warning</sh-icon>
            }
            @if (item.formView.type == 'BucketnameB2' && !isFieldEmpty && !isValidBucketnameB2(fieldValue)) {
              <sh-icon class="warn" i18n-shTooltip shTooltip="Bucket name is invalid">warning</sh-icon>
            }
          </label>

          <input
            [type]="item.formView.type === 'Email' ? 'email' : 'text'"
            [id]="formFieldId"
            [ngModel]="formInput"
            autocomplete="off"
            (keydown)="onKeyDown(item.fieldGroup, item.formView.name, item.formView.type, $event)"
            (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />

          @let inputValue = fieldValue;
          @let hasLeadingSlashes = hasLeadingSlash(inputValue ?? '');
          @let leadingSlashesMessage = hasLeadingSlashes && item.formView.doubleSlash?.message;
          @let slashType = item.formView.doubleSlash?.type;

          @if (item.formView.type === 'Path') {
            <sh-icon
              prefix
              [class.error]="leadingSlashesMessage && slashType === 'error'"
              [class.warn]="leadingSlashesMessage && slashType === 'warning'"
              [shTooltip]="leadingSlashesMessage">
              link
            </sh-icon>
          } @else if (item.formView.type === 'Email') {
            <sh-icon prefix>envelope</sh-icon>
          } @else if (item.formView.type === 'Hostname') {
            <sh-icon prefix>hard-drives</sh-icon>
          } @else if (item.formView.type === 'Bucketname' || item.formView.type === 'BucketnameB2') {
            <sh-icon prefix>jar</sh-icon>
          } @else {
            <sh-icon prefix>textbox</sh-icon>
          }
        </sh-form-field>
      } @else if (item.formView.type === 'Password') {
        <sh-form-field>
          <label [for]="formFieldId">
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
          <input
            [type]="$any(item.formView).showPassword ? 'text' : 'password'"
            autocomplete="off"
            [id]="formFieldId"
            [ngModel]="formInput"
            (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />

          @if (item.oauthField === item.formView.name) {
            <span
              prefix
              class="link"
              (click)="
                oauthStartTokenCreation(
                  item.destinationType,
                  item.fieldGroup,
                  item.formView.name,
                  item.formView.oauthVersion
                )
              ">
              AuthID
            </span>
          } @else {
            <sh-icon prefix>password</sh-icon>
          }
          @if ($any(item.formView).showPassword) {
            <sh-icon
              class="clickable"
              suffix
              (click)="$any(item.formView).showPassword = !$any(item.formView).showPassword">
              eye
            </sh-icon>
          } @else {
            <sh-icon
              class="clickable"
              suffix
              (click)="$any(item.formView).showPassword = !$any(item.formView).showPassword">
              eye-slash
            </sh-icon>
          }
        </sh-form-field>
      } @else if (item.formView.type === 'Enumeration') {
        @let options = mapOptions(item.formView);

        @if (options) {
          <sh-select
            [options]="options"
            [isClearable]="false"
            [optionTemplate]="enumOptionTemplate"
            label="key"
            value="value">
            <label [for]="formFieldId">
              @if (item.formView.isMandatory && isFieldEmpty) {
                <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
              }
              {{ labelContent }}
              @if (item.formView.longDescription) {
                <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
              }
            </label>
            <input
              type="text"
              [id]="formFieldId"
              [ngModel]="formInput"
              (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />
          </sh-select>

          <ng-template let-option #enumOptionTemplate>
            {{ option.key }} {{ option.value && option.value != option.key ? '(' + option.value + ')' : '' }}
          </ng-template>
        }
      } @else if (item.formView.type === 'NonValidatedSelectableString') {
        @let options = mapOptionsWithFreeText(item.formView, formInput);

        @if (options) {
          <sh-select
            [options]="options"
            [asFreeText]="true"
            [inlineSearch]="true"
            [optionTemplate]="nonValidatedOptionTemplate"
            label="key"
            value="value">
            <label [for]="formFieldId">
              @if (item.formView.isMandatory && isFieldEmpty) {
                <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
              }
              {{ labelContent }}
              @if (item.formView.longDescription) {
                <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
              }
            </label>

            <input
              type="text"
              [id]="formFieldId"
              [ngModel]="formInput"
              (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />
          </sh-select>

          <ng-template let-option #nonValidatedOptionTemplate>
            {{ option.key }} {{ option.value && option.value != option.key ? '(' + option.value + ')' : '' }}
          </ng-template>
        } @else {
          <sh-progress-bar class="indeterminate primary" />
        }
      } @else if (item.formView.type === 'Size') {
        <app-size
          [inputType]="item.Name"
          [ngModel]="formInput"
          (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)"
          [customId]="formFieldId">
          <label [for]="formFieldId">
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
        </app-size>
      } @else if (item.formView.type === 'Integer') {
        <sh-form-field>
          <label [for]="formFieldId">
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
          <input
            type="number"
            [id]="formFieldId"
            [ngModel]="formInput"
            (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />
          <sh-icon prefix>numpad</sh-icon>
        </sh-form-field>
      } @else if (item.formView.type === 'Boolean') {
        <sh-toggle
          class="primary raised"
          [class.active]="isTrue(formInput)"
          (click)="updateFieldValue(item.fieldGroup, item.formView.name, isTrue(formInput) ? 'false' : 'true')">
          <label [for]="formFieldId">
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
        </sh-toggle>
      } @else if (item.formView.type === 'Flags') {
        @let options = mapOptions(item.formView);

        @if (options) {
          <sh-select
            [options]="options"
            [selectMultiple]="true"
            key="key"
            value="value"
            class="primary raised"
            [optionTemplate]="optionTemplate">
            <label [for]="formFieldId">
              @if (item.formView.isMandatory && isFieldEmpty) {
                <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
              }
              {{ labelContent }}
              @if (item.formView.longDescription) {
                <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
              }
            </label>
            <input
              type="text"
              id="text"
              [ngModel]="formInput"
              (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)" />
          </sh-select>

          <ng-template let-option #optionTemplate>
            {{ option.key }} {{ option.value && option.value != option.key ? '(' + option.value + ')' : '' }}
          </ng-template>
        }
      } @else if (item.formView.type === 'Timespan' || item.formView.type === 'DateTime') {
        <app-timespan
          [inputType]="item.formView.name"
          [ngModel]="formInput"
          (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)"
          [customId]="formFieldId">
          <label [for]="formFieldId">
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ labelContent }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
        </app-timespan>
      } @else if (item.formView.type === 'FreeText') {
        <app-file-drop-textarea
          [ngModel]="formInput"
          (ngModelChange)="updateFieldValue(item.fieldGroup, item.formView.name, $event)"
          [customId]="formFieldId"
          [placeholder]="item.formView.longDescription">
          <label>
            @if (item.formView.isMandatory && isFieldEmpty) {
              <sup i18n-shTooltip shTooltip="This field is mandatory">*</sup>
            }
            {{ item.formView.shortDescription ?? item.formView.name }}
            @if (item.formView.longDescription) {
              <sh-icon class="primary" [shTooltip]="item.formView.longDescription">question</sh-icon>
            }
          </label>
        </app-file-drop-textarea>
      }

      @if (item.fieldGroup === 'advanced') {
        <button shButton class="outlined" type="button" (click)="removeAdvancedOption(item.formView.name)">
          <sh-icon>x-circle</sh-icon>
        </button>
      }
    </div>
  </ng-template>
}
