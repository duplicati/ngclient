<sh-toggle-card [disableToggle]="true">
  <ng-container title>
    <ng-container i18n>Advanced options</ng-container>

    <div class="actions">
      @if (showTextArea()) {
        <button shButton type="button" class="outlined small" (click)="showTextArea.set(false)" i18n>
          Show editor
          <sh-icon>link</sh-icon>
        </button>
      } @else {
        <sh-menu [searchable]="true">
          <button shButton type="button" class="outlined small" i18n>
            Add advanced option
            <sh-icon>plus</sh-icon>
          </button>

          <ng-container menu>
            @for (group of nonSelectedOptionsGrouped(); track $index) {
              <h3 title>{{ group.displayName }}</h3>

              @for (option of group.options; track $index) {
                <button
                  #option
                  type="button"
                  [class.deprecated]="option.deprecatedDescription"
                  (click)="addSetting(option)">
                  <div class="option-col">
                    <p>{{ option.shortDescription }}</p>
                    {{ option.name }}
                  </div>
                </button>
              }
            }
          </ng-container>
        </sh-menu>

        @if (hasFreeTextSettings()) {
          <sh-menu>
            <button shButton type="button" class="small">
              <sh-icon>dots-three-vertical</sh-icon>
            </button>

            <ng-container menu>
              <button shButton type="button" class="outlined small" (click)="addFreeTextSetting()" i18n>
                <sh-icon>pen</sh-icon>
                New custom option
              </button>

              <button shButton type="button" class="small" (click)="showTextArea.set(true)">
                <sh-icon>link</sh-icon>
                Edit contents as text
              </button>
            </ng-container>
          </sh-menu>
        }
      }
    </div>
  </ng-container>

  @if (showTextArea()) {
    <textarea
      class="raw-text-area"
      wrap="off"
      [ngModel]="settingsAsText()"
      (ngModelChange)="updateSettingsFromText($event)"
      [ngModelOptions]="{ updateOn: 'blur' }"
      placeholder="Paste advanced options here, one per line."></textarea>
  } @else {
    @if (selectedSettings().length === 0) {
      <div class="placeholder">Add a setting above to get started.</div>
    }

    @for (item of selectedSettings(); track $index) {
      @let formId = 'destination-' + item.Name + $index;
      @let inApplicationOptions = inAppOptions($any(item.Name));

      <ng-template #defaultLabel>
        @if (inApplicationOptions) {
          <sh-icon
            class="error"
            i18n-shTooltip
            shTooltip="By adding this option it will override the matching global option">
            warning-octagon
          </sh-icon>
        }
        <span [class.deprecated]="item.FormView.deprecatedDescription">{{ item.FormView.shortDescription }}</span>

        @if (item.FormView.deprecatedDescription) {
          <sh-icon class="warn" [shTooltip]="item.FormView.deprecatedDescription">archive</sh-icon>
        } @else if (item.FormView.longDescription) {
          <sh-icon class="primary" [shTooltip]="item.FormView.longDescription">question</sh-icon>
        }
      </ng-template>

      <div
        class="field-row"
        [class.align-remove-start]="
          item.FormView.type === 'FolderTree' || item.FormView.type === 'FileTree' || item.FormView.type === 'Boolean'
        ">
        @if (item.FormView.type === 'FreeText') {
          <div class="form-column">
            <label>
              <ng-container *ngTemplateOutlet="defaultLabel" />
            </label>

            <div>
              <sh-form-field>
                <input type="text" [ngModel]="item.Name" (ngModelChange)="updateFreeTextSettingName(item, $event)" />

                <sh-icon prefix>rectangle-dashed</sh-icon>
              </sh-form-field>
            </div>
            <div>
              <sh-form-field>
                <input type="text" [ngModel]="item.Value()" (ngModelChange)="updateSettingValue(item, $event)" />

                <sh-icon prefix>textbox</sh-icon>
              </sh-form-field>
            </div>
          </div>
        } @else if (item.FormView.type === 'FileTree') {
          <app-file-tree
            [startingPath]="item.Value()"
            [accepts]="item.FormView.accepts"
            [showFiles]="true"
            [showHiddenNodes]="true"
            [selectFiles]="true">
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
            </label>
            <input
              type="text"
              [id]="formId"
              [ngModel]="item.Value()"
              (ngModelChange)="updateSettingValue(item, $event)" />
          </app-file-tree>
        } @else if (item.FormView.type === 'FolderTree') {
          <app-file-tree [startingPath]="item.Value()">
            <label [for]="formId"></label>
            <input
              type="text"
              [id]="formId"
              [ngModel]="item.Value()"
              (ngModelChange)="updateSettingValue(item, $event)" />
          </app-file-tree>
        } @else if (
          item.FormView.type === 'String' ||
          item.FormView.type === 'Path' ||
          item.FormView.type === 'Decimal' ||
          item.FormView.type === 'Email' ||
          item.FormView.type === 'Hostname' ||
          item.FormView.type === 'Bucketname'
        ) {
          <sh-form-field>
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>

            <input
              [type]="item.FormView.type === 'Email' ? 'email' : 'text'"
              [id]="formId"
              [ngModel]="item.Value()"
              (ngModelChange)="updateSettingValue(item, $event)" />

            @if (item.FormView.type === 'Path') {
              <sh-icon prefix>link</sh-icon>
            } @else if (item.FormView.type === 'Hostname') {
              <sh-icon prefix>hard-drives</sh-icon>
            } @else if (item.FormView.type === 'Bucketname') {
              <sh-icon prefix>jar</sh-icon>
            } @else if (item.FormView.type === 'Email') {
              <sh-icon prefix>envelope</sh-icon>
            } @else {
              <sh-icon prefix>textbox</sh-icon>
            }
          </sh-form-field>
        } @else if (item.FormView.type === 'Password') {
          <sh-form-field>
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>

            <input
              [type]="$any(item).showPassword ? 'text' : 'password'"
              autocomplete="off"
              [id]="formId"
              [ngModel]="item.Value()"
              (ngModelChange)="updateSettingValue(item, $event)" />

            <sh-icon prefix>password</sh-icon>
            @if ($any(item).showPassword) {
              <sh-icon class="clickable" suffix (click)="$any(item).showPassword = !$any(item).showPassword">
                eye
              </sh-icon>
            } @else {
              <sh-icon class="clickable" suffix (click)="$any(item).showPassword = !$any(item).showPassword">
                eye-slash
              </sh-icon>
            }
          </sh-form-field>
        } @else if (item.FormView.type === 'Enumeration') {
          <sh-select [options]="item.FormView.options!" [isClearable]="false" [optionTemplate]="enumOptionTemplate">
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>

            <input
              type="text"
              [id]="formId"
              [ngModel]="item.Value()"
              (ngModelChange)="updateSettingValue(item, $event)" />
          </sh-select>

          <ng-template let-item #enumOptionTemplate>
            {{ item }}
          </ng-template>
        } @else if (item.FormView.type === 'Size') {
          <app-size
            [inputType]="item.Name"
            [ngModel]="item.Value()"
            (ngModelChange)="updateSettingValue(item, $event)"
            [customId]="formId">
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>
          </app-size>
        } @else if (item.FormView.type === 'Integer') {
          <sh-form-field>
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>
            <input
              type="number"
              [id]="formId"
              [ngModel]="item.Value()"
              (ngModelChange)="updateSettingValue(item, $event)" />
            <sh-icon prefix>numpad</sh-icon>
          </sh-form-field>
        } @else if (item.FormView.type === 'Boolean') {
          <sh-toggle class="primary raised">
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>

            <input
              type="checkbox"
              [id]="formId"
              [ngModel]="item.Value()"
              (ngModelChange)="updateSettingValue(item, $event)" />
          </sh-toggle>
        } @else if (item.FormView.type === 'Flags') {
          <sh-select
            class="primary raised"
            [options]="item.FormView.options!"
            [selectMultiple]="true"
            [optionTemplate]="optionTemplate">
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>
            <input type="text" id="text" [ngModel]="item.Value()" (ngModelChange)="updateSettingValue(item, $event)" />
          </sh-select>

          <ng-template let-item #optionTemplate>
            {{ item }}
          </ng-template>
        } @else if (item.FormView.type === 'Timespan' || item.FormView.type === 'DateTime') {
          <app-timespan
            [inputType]="item.Name"
            [ngModel]="item.Value()"
            (ngModelChange)="updateSettingValue(item, $event)"
            [customId]="formId">
            <label [for]="formId">
              <ng-container *ngTemplateOutlet="defaultLabel" />
              <ng-container
                *ngTemplateOutlet="
                  validateTemplate;
                  context: {
                    $implicit: {
                      formView: item.FormView,
                    },
                  }
                "></ng-container>
            </label>
          </app-timespan>
        }

        <button shButton class="outlined small remove-btn" type="button" (click)="removeSetting(item)">
          <sh-icon>x-bold</sh-icon>
        </button>
      </div>
    }
  }
</sh-toggle-card>

<ng-template #validateTemplate let-item>
  @if (item.Value) {
    @let fieldValue = item.Value();
    @let isFieldEmpty = (fieldValue ?? '').toString().trim() === '';
    @if (!isFieldEmpty && item.formView.validate) {
      @let validationResult = item.formView.validate(fieldValue);
      @if (validationResult?.type === 'error') {
        <sh-icon class="error" [shTooltip]="validationResult?.message ?? 'Invalid value'">x-circle</sh-icon>
      } @else if (validationResult?.type === 'warning') {
        <sh-icon class="warn" [shTooltip]="validationResult?.message ?? 'Invalid value'">warning</sh-icon>
      }
    }
  }
</ng-template>
